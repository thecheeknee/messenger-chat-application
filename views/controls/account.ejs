<script type="text/javascript">
  /* eslint-disable no-undef */
  /* eslint-disable no-unused-vars */
  let loginScreen, waitingScreen, errorScreen, notVerifiedScreen, notFoundScreen, adminMissingScreen;

  class Account {
    #apiUrl;

    constructor() {
      this.#apiUrl = '<%= url %>';
      this._get = 'GET';
      this._post = 'POST';
    }

    #fetchApi (url, type, data) {
      const fetchUrl = this.#apiUrl + url;
      
      const body = JSON.stringify(data);
      return fetch(fetchUrl, {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }, method: type,
        body,
      }).then((response) => {
        return response.json();
      });
    }

    registerNewAccount (userName, name, email, type, password, confirmPassword, adminName) {
      try {
        const accountInfo = {
          userName, name, email, type, password, confirmPassword, adminName
        };

        const addUser = this.#fetchApi('/user-register', this._post, accountInfo);

        addUser
          .then(json => {
            if (json.success) {
              waitingScreen.classList.add('d-none');
              if (json.detail === 'agent') {
                notVerifiedScreen.classList.remove('d-none');
              }
              if (json.detail === 'admin') {
                //redirect to admin dashboard
              }
            } else throw json;
          })
          .catch(err => {
            const errorCode = err.error.code;
            waitingScreen.classList.add('d-none');
            switch (errorCode) {
              case 'admin_missing':
                adminMissingScreen.classList.remove('d-none');
                break;
              case 'user_exists':
                notFoundScreen.classList.remove('d-none');
                break;
              case 'password_invalid':
              case 'invalid_details':
              default:
                errorScreen.classList.remove('d-none');
                break;
            }
          });
      } catch (error) {
        console.log(error);
        errorScreen.classList.remove('d-none');
      }
    }

    loginToDashboard (email, password, type, userName = '') {
      try {
        const loginData = {
          email,
          password,
          userName,
          type
        }
        const loginCheck = this.#fetchApi('/user-login', this._post, loginData);

        loginCheck
          .then(json => {
            if (json.success) {
              waitingScreen.classList.add('d-none');
              if (json.detail === 'agent') {
                // redirect to agent dashboard
              }
              if (json.detail === 'admin') {
                //redirect to admin dashboard
              }
            } else throw json;
          })
          .catch(err => {
            const errorCode = err.error.code;
            waitingScreen.classList.add('d-none');
            switch (errorCode) {
              case 'verification_failed':
                notVerifiedScreen.classList.remove('d-none');
                break;
              case 'user_not_found':
                notFoundScreen.classList.remove('d-none');
                break;
              case 'password_invalid':
              case 'invalid_details':
              default:
                errorScreen.classList.remove('d-none');
                break;
            }
          });
      }
      catch (error) {
        console.log(error);
        errorScreen.classList.remove('d-none');
      }
    }
  }

  (function () {
    const pathname = window.location.pathname.split('/')[1];
    switch(pathname) {
      case 'login':
        loginScreen = document.getElementById('loginScreen');
        waitingScreen = document.getElementById('waiting');
        errorScreen = document.getElementById('error');
        notVerifiedScreen = document.getElementById('verifyPending');
        notFoundScreen = document.getElementById('notFound');
        document.getElementById('accEmail').addEventListener('change', validate, false);
        document.getElementById('accType').addEventListener('change', validate, false);
        document.getElementById('adminUserName').addEventListener('change', validate, false);
        document.getElementById('staffLogin').addEventListener('submit', staffLogin, false);
        clearCookies();
        break;
      case 'agent-register':
        loginScreen = document.getElementById('loginScreen');
        waitingScreen = document.getElementById('waiting');
        errorScreen = document.getElementById('error');
        notVerifiedScreen = document.getElementById('verifyPending');
        adminMissingScreen = document.getElementById('adminMissing');
        notFoundScreen = document.getElementById('notFound');
        clearCookies();
        break;
      case 'logout':
      default:
        break;
    }
  })();

  function clearCookies () {
    const cookies = document.cookie.split(";");
    cookies.forEach((cookie) => {
      document.cookie = cookie + "=;expires=" + new Date(0).toUTCString();
    });
  }

  function validate(e) {
    const key = e.target;
    const value = e.target.value;
    switch (key.id) {
      case 'accEmail':
        if (!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(value)) key.classList.add('is-invalid');
        else key.classList.remove('is-invalid');
        break;
      case 'accType':
        if (value === 'admin') {
          document.getElementById('adminUserName').setAttribute('required', true);
          document.getElementById('adminUserName').parentNode.classList.remove('d-none');
        } else {
          document.getElementById('adminUserName').removeAttribute('required');
          document.getElementById('adminUserName').value = '';
          document.getElementById('adminUserName').parentNode.classList.add('d-none');
        }
        break;
      case 'adminUserName':
        if (value === '') key.classList.add('is-invalid');
        else key.classList.remove('is-invalid');
        break;
    }
  }

  function staffLogin (e) {
    if (e.target.checkValidity() && document.querySelectorAll('.is-invalid').length === 0) {
      e.preventDefault();
      e.stopPropagation();

      const email = document.getElementById('accEmail').value;
      const type = document.getElementById('accType').value;
      const userName = document.getElementById('adminUserName').value;
      const password = document.getElementById('accPassword').value;

      loginScreen.classList.add('d-none');
      waitingScreen.classList.remove('d-none');

      const acc = new Account();
      acc.loginToDashboard(email, password, type, userName);
    } else return false;
  }
</script>